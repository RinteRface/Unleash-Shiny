---
title: "Unleash Shiny"
subtitle: "R/Pharma - Advanced Shiny Workshop"
author: "David Granjon (Novartis) & John Coene (World Economic Forum)"
date: "13-03-2020"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["assets/css/style.css", "assets/css/xaringan-extra.css", "https://cdn.jsdelivr.net/npm/devices.css@0.1.15/dist/devices.min.css"]
    includes:
      after_body: assets/html/includes.html
    mathjax: false
    nature:
      ratio: "16:9"
      highlightStyle: docco
      highlightLines: true
      countIncrementalSlides: false
---

<style>
.title-slide {
  background-image: url(assets/img/bg/front_cover.jpg);
}
</style>

```{r setup, include = FALSE}
if(!requireNamespace("emo", quietly = TRUE))
  remotes::install_github("hadley/emo")

if(!requireNamespace("DiagrammeR", quietly = TRUE))
  install.packages("DiagrammeR")

library(emo)
library(countdown)
library(shiny)
library(htmltools)
library(charpente)
library(XML)
xaringanExtra::use_xaringan_extra(c("tile_view", "animate_css", "tachyons"))
xaringanExtra::use_extra_styles(
  hover_code_line = TRUE,         #<<
  mute_unhighlighted_code = TRUE  #<<
)

# lighten cli messages for better slide rendering
html_2_R <- function(html, prefix = FALSE) {
  r_output <- html %>%
   htmlParse() %>%
    getNodeSet("/html/body/*") %>%
    `[[`(1) %>%
    charpente:::render_node(prefix = prefix)

  if (exists("r_output")) {
    cli::cli_code(styler::style_text(r_output))
  } else {
    cli::cli_alert_danger("Failed to convert code.")
  }
}

```

```{r js4shiny, echo=FALSE}
js4shiny::html_setup(stylize = c("fonts", "variables", "code"))
```

# About us

.flex.tc[
.w-30.mr3[
<img class="br-100" src="assets/img/people/david.jpg" />
.f5[David]

.small[Data Scientist at Novartis]
.small[[RinteRface](https://rinterface.com/) founder]
.small[Known for: `{shinydashboardPlus}`, `{bs4Dash}` and `{shinyMobile}`]

.gray[&commat;divadnojnarg]
]

.w-30.mr3[
<img class="br-100" src="assets/img/people/john.jpg" />
.f5[John]

.small[Data scientist at the World Economic Forum]
.small[Known for: `{echarts4r}` and `{waiter}`]

.gray[&commat;jdatap]
]


.w-30.mr3[
<img class="br-100" src="assets/img/people/colin.jpg" />
.f5[Colin]

.small[Shiny Expert at ThinkR]
.small[Known for: `{golem}`, https://engineering-shiny.org/]

.gray[&commat;_ColinFay]
]


]

---
# Plan

We're in for 4 hours of fun!

- Grab a coffee
- Make yourself comfortable
- Ask questions!  

1. Quick intro on shiny under the hood
2. Custom inputs
3. Pause
4. Custom outputs
5. Q & A

---

# Workshop Material

.f5.w-70.mh-a.mt4[
```r
devtools::install_github(
  "RinteRface/charpente",
  dependencies = TRUE
)
```

.tc.mt4[
[Rstudio Cloud](https://rstudio.cloud/)
]
]

---
class: center

# Shiny or not Shiny?
<div class="device device-iphone-8 device-spacegray" style="position: absolute; left: 0; right: 0;
top: 0; bottom: 0; margin: auto; max-width: 100%; max-height: 100%; transform: scale(0.6);">
<div class="device-frame">
<iframe width="100%" src="https://shiny.john-coene.com/coronavirus/" allowfullscreen="" frameborder="0" height="100%" scrolling="auto"></iframe>
</div>
<div class="device-stripe"></div>
<div class="device-header"></div>
<div class="device-sensors"></div>
<div class="device-btns"></div>
<div class="device-power"></div>
</div>

---
# Shiny or not Shiny?

<div class="device device-macbook-pro device-spacegray" style="position: absolute; left: 0; right: 0;
top: 0; bottom: 0; margin: auto; max-width: 100%; max-height: 100%; transform: scale(1);">
<div class="device-frame">
<iframe width="100%" src="https://themeon.net/nifty/v2.9.1/widgets.html" allowfullscreen="" frameborder="0" height="100%" scrolling="auto"></iframe>
</div>
<div class="device-stripe"></div>
<div class="device-header"></div>
<div class="device-sensors"></div>
<div class="device-btns"></div>
<div class="device-power"></div>
</div>

---

# Shiny or not Shiny?

<div class="device device-macbook-pro device-spacegray" style="position: absolute; left: 0; right: 0;
top: 0; bottom: 0; margin: auto; max-width: 100%; max-height: 100%; transform: scale(1);">
<div class="device-frame">
<iframe width="100%" src="https://dgranjon.shinyapps.io/shinyMons/" allowfullscreen="" frameborder="0" height="100%" scrolling="auto"></iframe>
</div>
<div class="device-stripe"></div>
<div class="device-header"></div>
<div class="device-sensors"></div>
<div class="device-btns"></div>
<div class="device-power"></div>
</div>

---

# A simple Shiny app

#### No HTML/CSS/JS and it just works `r ji("fear")`! What kind of **magic** is this?

<iframe src="https://gallery.shinyapps.io/050-kmeans-example" height="400px" width="100%"></iframe>


---

<video style="position: fixed;
  right: 0;
  bottom: 0;
  min-width: 100%;
  min-height: 100%;
  width: 100%; "loop="" autoplay="" poster="assets/img/bg/virtual_patient.png">
<source src="assets/movies/VirtualPatient.mp4" type="video/mp4">
</video>

---
class: break center middle
background-image: url('assets/img/bg/part1.jpg')
background-size: cover

<h2 class="white n">Part1. Shiny and the Web</h1>

---
class: header_background
# A. Shiny generates HTML from R
## Warmup 1
1. Run the following code:

```{r, eval=FALSE}
p("Hello World")
```

2. Copy and paste this code to the R console. What do you observe?

---
class: header_background
# A.1.1 Introduction to HTML: **tags**
## The simplest HTML skeleton
.pull-left.w-70.mh-a[
```html
<!DOCTYPE HTML>
<html>
  <head>
  <!-- head content here -->
  </head>
  <body>
  <!-- body content here -->
  </body>
</html>
```

]

.pull-right.small[
There are 2 types of **tags**:
  - paired-tags:`<div></div>`
  - self closing tags: `<img/>`
  
We classify them by usage:

  - structural tags: `<head></head>`, `<body></body>`
  - control tags: `<script></script>`, `<button></button>`
  - formatting tags: `<font></font>`
  
Block vs inline:

  - `<div><p>Hello World</p></div>`: .green[Good]
  - `<span><div><p>Hello World</p></div></span>`: .red[not good]

]

---
class: header_background
# A.1.2 Introduction to HTML: **attributes**
## Attributes specify the tags properties
.pull-left.w-70.mh-a[
```html
<div class="awesome-item" id="myitem"></div>
<!-- the class awesome-item may be applied to multiple tags -->
<span class="awesome-item"></span>
```

]


.pull-right[
The most common attributes:
  - **class** may be shared between multiple tags
  - **id** is unique
  - non standards attributes like `data-toggle`
  
Attributes are used by CSS and JavaScript to interact with the web page!
]

---
class: header_background
# A.2.1 About the Document Object Model
## Visualizing the DOM with the HTML inspector

.pull-left[
DOM is a convenient representation (tree) of the HTML document 
Inspect the code of any web page with Firefox or Chrome:

  - after a right click and selecting inspect
  - after clicking on F12 (windows), fn + F12 (Mac)
]

.pull-right[
```{r html-dom, echo=FALSE, fig.cap='DOM representation', out.width='50%'}
knitr::include_graphics("assets/img/html_DOM.png")
```
]

--- 
class: header_background
# A.2.2 About the DOM: exercise
## Warmup 2
.pull-left.w-70.mh-a[
```r
library(shiny)
ui <- fluidPage(p("Hello World"))
server <- function(input, output) {}
shinyApp(ui, server)
```
]

.pull-right[
  - Run the above app, right click on the only text element and select inspect
  - In the `Elements` panel, double click between the `<p></p>` tag to edit the current text. Press enter when finished
]

---
class: header_background
# B. Discover Shiny dependencies
## Warmup 3

Let's play `r ji("play")`:

  1. Run the app `runExample("01_hello")`
  2. Open the HTML inspector
  3. Delete the bootstrap.min.css and ion.rangeSlider.css
  4. Conclusions


---
class: header_background
# C. Unleash `{htmltools}` 
`{htmltools}` is a R package designed to:
  - Generate HTML tags from R
  - Handle web dependencies: add, remove, resolve, ...

Historically, `{htmltools}` was extracted out of `{shiny}` to extend it. That's why, both packages
have many common functions! 

At the moment, `{htmltools}` does not have any user guide, although being an important package for all web things
[![](https://cranlogs.r-pkg.org/badges/htmltools)](https://cran.r-project.org/package=htmltools)

---
class: header_background
# C.1.1 Handle dependencies
## How would you include JS/CSS in a Shiny app?

.pull-left.w-70.mh-a.small[
Works but not **portable**

```r
fluidPage(
  tags$head(
    tags$style(...),
    tags$script(src = "path-to-script"),
    tags$script(
      "$(function() {
       // JS logic ...
      });
      "
    )
  )
)
```
]

.pull-right.w-70.mh-a.small[
With `{htmltools}`, we define the dependency, then attach it to a tag with `tagList`:

```r
use_bs4_dep <- function(tag) {
  bs4_dep <- htmlDependency(
    name = "Bootstrap 4",
    version = "1.0",
    src = c(href = "https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/"),
    stylesheet = "bootstrap.min.css"
  )
  tagList(tag, bs4_dep)
}
use_bs4_dep(fluidPage())
```
]

---
class: header_background
# C.1.2 Handle dependencies
## Exercise 1

Open `htmltools_deps.Rmd` and complete exercise 1

`r countdown(10)`

---
class: header_background
# C.2.1 From HTML to R `r ji("wizard")`
## HTML VS R
.pull-left.w-70.mh-a[
In HTML, we have:
```html
<div class="divclass" id = "daddy">
  <h1>A child</h1>
  <span class="child" id="baby">Crying</span>
</div>
```
]

.pull-right.w-70.mh-a[
The corresponding R code is 

```{r}
mytag <- div(
  class = "divclass",
  id = "daddy",
  h1("A child"),
  span(class = "child", id = "baby", "Crying")
)
```
]

Some tags like `<nav></nav>` need the `tags$` prefix before (`tags` is a list of functions). The `withTags` function to use `tags$<tagName>`


---
class: header_background
# C.2.2 Automate the conversion? 
.center[
```{r thug-life, echo=FALSE, out.width='10%'}
knitr::include_graphics("assets/img/thug_life.png")
```
]

This process is not interesting and time consuming! Tools exist:

  - html2R [Shiny app](https://alandipert.shinyapps.io/html2r/) converts HTML to R (thanks Alan Dipert)
  - `{charpente}` does the same from the R console with `html_2_R` 
  
.small[
```{r}
html_2_R('<div class="divclass" id = "daddy"></div>')
```
]


---
class: header_background
# C.2.3 Accessing R tags attributes
How to access name, attributes, children?

We could use `str(mytag)` to inspect the structure of the R object.

.small[
```{r}
mytag$attribs 
mytag$children 
```
]

---
class: header_background
# C.2.4 Manipulate R tags
## Add new attributes
There are 2 methods:
 - `tagAppendAttributes(tag, list of attributes)` is preferred
 -`tag$attribs[["new-attribute"]] <- value`

## Add child/children
`tagAppendChild(tag, child)`, `tagAppendChildren(tag, list of children)`

There exist other functions but we'll not use them.


---
class: header_background
# C.2.4 Programmatically create children elements
Let's create 5 `span` tags:

.pull-left.w-70.mh-a[
```r
div(
  span(1),
  span(2),
  span(3),
  span(4),
  span(5)
)
```

What about 100 tags `r ji("fear")`?

]

.pull-right.w-70.mh-a[
Let's do some functional programming!
```r
# base R
div(lapply(1:5, function(i) span(i)))
# purrr + %>%
map(1:5, function(i) span(i)) %>% div()
```
]


---
class: header_background
# C.2.4 Wrap up
## Exercise 2

Open `htmltools_HTML_to_R.Rmd` and complete exercise 1 and 2

`r countdown(15)`


---
class: header_background
# D. Practice: bulma
In the following, you'll reconstruct the `{shinyBulma}` package step by step!
.center[
```{r shinybulma, echo=FALSE, out.width='25%'}
knitr::include_graphics("assets/img/shinybulma.svg")
```
]

---
class: header_background
# S. Multi page applications `r ji("page")` `r ji("page")` `r ji("page")`

"Traditional" applications and websites

.pull-left.w-70.mh-a[
```{r, echo=FALSE, fig.align='center', out.width="100%", fig.dim=c(3, 6)}
DiagrammeR::grViz("
strict digraph{
  graph[rankdir=LR fontsize = 10]
  node [shape=record fontsize=10];
  s [label='Server' color=cornflowerBlue];
  c [label='Client' color=gold];
  c -> s [color=dimGray arrowsize=.3 label=request fontsize = 9];
  s -> c [color=dimGray arrowsize=.3 label=response fontsize = 9];

  c1 [label='Client' color=gold];
  c1 -> s [color=dimGray arrowsize=.3 label=request fontsize = 9];
  s -> c1 [color=dimGray arrowsize=.3 label=response fontsize = 9];
}
")
```
]

.pull-right.w-70.mh-a[
  ### HTTP 1.1

  _A new page is requested_

  - Client requests `/`, server responds
  - Client requests `/about`, server gives a different response
  - Client requests `/products`, server gives a yet a different response
  - and so on
]

---
class: header_background
# S.1.1 Single page applications `r ji("page")`

A more recent web development.

.pull-left.w-70.mh-a[
```{r, echo=FALSE, fig.align='center', out.width="100%", fig.dim=c(3, 6)}
DiagrammeR::grViz("
digraph{
  graph[rankdir=LR fontsize = 10]
  node [shape=record fontsize=10];
  s [label='Server' color=cornflowerBlue];
  c1 [label='Client' color=gold];
  c2 [label='Client' color=gold];
  c3 [label='Client' color=gold];
  c1 -> s [dir=both color=dimGray arrowsize=.3 label=messages fontsize = 9];
  c2 -> s [dir=both color=dimGray arrowsize=.3 label=messages fontsize = 9];
  c3 -> s [dir=both color=dimGray arrowsize=.3 label=messages fontsize = 9];
}
")
```
]

.pull-right.w-70.mh-a[
  ### Websocket

  _Bi-directional communication_

  1. Client connects
  2. Client sends message
  3. Server (may) respond with another message
  4. Back to point 2
]

---
class: header_background
# S.1.2 What about shiny?

So which one of those does shiny use?

> Both!

But one (probably) more than the other...

When you visit a shiny app: 

1. Your browser makes an HTTP request to the shiny `server` which responds with the initial `ui`.
2. All subsequent communication is done via websocket (`input`, `output`).

_(no other `/page` is ever visited)_

---
class: header_background
# S.1.3 Serving an HTTP response

Shiny allows publishing any R object as a URL endpoint _unique to the session._

.pull-left-70[

```r
session$registerDataObj(
  "cars-data",            # endpoint 
  cars,                   # data
  function(data, req) {
    res <- jsonlite::toJSON(cars)
    shiny:::httpResponse(
      200L,               # status
      "application/json", # header 
      res                 # response
    )
  }
)
```

]

.pull-right-30[
```json
[
  {
    "speed": 4,
    "dist": 2
  },
  {
    "speed": 4,
    "dist": 10
  }
]
```
]

---
class: header_background
# S.1.3 Serving an HTTP response

<div class="confusing">
<h1 class="confusing-text">Too complicated!</h1>
</div>

Shiny allows publishing any R object as a URL endpoint _unique to the session._

.pull-left-70[

```r
session$registerDataObj(
  "cars-data",            # endpoint 
  cars,                   # data
  function(data, req) {
    res <- jsonlite::toJSON(cars)
    shiny:::httpResponse(
      200L,               # status
      "application/json", # header 
      res                 # response
    )
  }
)
```

]

.pull-right-30[
```json
[
  {
    "speed": 4,
    "dist": 2
  },
  {
    "speed": 4,
    "dist": 10
  }
]
```
]

---
class: break center middle
background-image: url('https://rstudio.com/assets/img/og/rstudio-og-fb-1.jpg')
background-size: cover

<h3 class="white n rstudio">Intermission</h3>
<p class="rstudio-comment">Open <code>http-intro.R</code></p>
